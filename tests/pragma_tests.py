from nose.tools import *
from azoth.hax2 import transactor
from azoth.hax2 import pragma
import unittest

def test_bag():
    bag = pragma.Bag()
    ok_(not bag)
    x = pragma.Pragma()
    bag.put(x)
    ok_(x in bag)
    eq_(1, len(bag))
    ok_(bag)
    bag.put(x)
    eq_(1, len(bag))
    y = pragma.Pragma()
    bag.put(y)
    eq_(2, len(bag))
    bag.remove(x)
    ok_(not x in bag)
    bag.remove(y)
    ok_(not bag)

def test_limited_bag():
    bag = pragma.Bag(limit=1)
    x = pragma.Pragma()
    y = pragma.Pragma()
    bag.put(x)
    assert_raises(IndexError, bag.put, y)
    ok_(x in bag)
    ok_(y not in bag)
    bag.remove(x)
    ok_(x not in bag)
    bag.put(y)
    ok_(y in bag)

def test_two_bags():
    bag1 = pragma.Bag()
    bag2 = pragma.Bag()
    eq_(bag1, bag2)
    x = pragma.Pragma()
    y = pragma.Pragma()
    bag1.put(x)
    bag2.put(x)
    eq_(bag1, bag2)
    bag1.put(y)
    ok_(bag1 != bag2)
    bag2.put(y)
    eq_(bag1, bag2)

def test_1x1_tray():
    tray = pragma.Tray()
    ok_(not tray)
    obj1 = pragma.Pragma()
    tray.put(obj1)
    ok_(tray)
    ok_(obj1 in tray)
    obj2 = pragma.Pragma()
    assert_raises(IndexError, tray.put, obj2)
    assert_raises(pragma.Occupied, tray.insert, 0, 0, obj2)
    assert_raises(IndexError, tray.insert, 0, 1, obj2)
    assert_raises(IndexError, tray.insert, 1, 0, obj2)
    assert_raises(IndexError, tray.insert, 0, -1, obj2)
    assert_raises(IndexError, tray.insert, -1, 0, obj2)
    assert_raises(ValueError, tray.remove, obj2)
    tray.remove(obj1)
    ok_(not tray)
    tray.insert(0, 0, obj2)
    ok_(tray)
    ok_(obj2 in tray)
    eq_((0, 0), tray.index(obj2))
    eq_(obj2, tray.access(0, 0))
    assert_raises(IndexError, tray.access, 0, 1)
    assert_raises(IndexError, tray.access, 1, 0)
    assert_raises(IndexError, tray.access, 0, -1)
    assert_raises(IndexError, tray.access, -1, 0)
    tray.delete(0, 0)
    ok_(not tray)
    tray.delete(0, 0)
    tray.insert(0, 0, obj2)
    tray.clear()
    ok_(not tray)

def test_2x2_tray():
    tray = pragma.Tray(2, 2)
    ok_(not tray)
    obj = []
    for i in range(5):
        obj.append(pragma.Pragma())

    for i in range(4):
        print(len(tray))
        print(tray)
        tray.put(obj[i])
        ok_(obj[i] in tray)
    eq_(4, len(tray))
    ok_(tray.full)

    assert_raises(IndexError, tray.put, obj[4])
    ok_(obj[4] not in tray)

    assert_raises(pragma.Occupied, tray.insert, 0, 0, obj[4])
    assert_raises(IndexError, tray.insert, 0, 2, obj[4])
    assert_raises(IndexError, tray.insert, 2, 0, obj[4])
    assert_raises(IndexError, tray.insert, 0, -1, obj[4])
    assert_raises(IndexError, tray.insert, -1, 0, obj[4])
    assert_raises(ValueError, tray.remove, obj[4])

    assert_raises(IndexError, tray.available)

    x, y = tray.index(obj[0])
    tray.remove(obj[0])
    eq_(3, len(tray))
    ok_(not tray.full)
    eq_((x, y), tray.available())
    tray.insert(x, y, obj[4])
    eq_((x, y), tray.index(obj[4]))

    assert_raises(IndexError, tray.access, 0, 2)
    assert_raises(IndexError, tray.access, 2, 0)
    assert_raises(IndexError, tray.access, 0, -1)
    assert_raises(IndexError, tray.access, -1, 0)

    tray.delete(0, 0)
    eq_(3, len(tray))
    tray.delete(0, 0)
    eq_(3, len(tray))

    tray.clear()
    ok_(not tray)

def test_two_trays():
    tray1 = pragma.Tray(2, 2)
    tray2 = pragma.Tray(2, 2)
    eq_(tray1, tray2)
    x = pragma.Pragma()
    y = pragma.Pragma()
    tray1.put(x)
    tray2.put(x)
    eq_(tray1, tray2)
    tray1.put(y)
    ok_(tray1 != tray2)
    tray2.put(y)
    eq_(tray1, tray2)
    
